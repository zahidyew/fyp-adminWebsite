<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta http-equiv="X-UA-Compatible" content="ie=edge">
   <link rel="stylesheet" type="text/css" href="./css/style.css">
   <title>Add Quiz</title>
</head>

<body>
   <h1>Add Quiz</h1>
   <div id="">
      Quiz Name: <input type="text" name="quizName" id="quizName" required><br>
      <!-- Logo: <input type="file" name="file" id="file"><br>
      Date: <input type="date" name="date" id="date"><br>
      Time: <input type="time" name="time" id="time"><br> -->
      Number of Questions: <input type="number" name="numOfQues" id="numOfQues" min="1" required><br>
      Time Limit: <input type="number" name="timeLimit" id="timeLimit" min="1" required><br>
      <button type="submit" name="submit" id="submit">Submit</button>
      <button type="reset" name="reset" id="reset">Reset</button>
   </div><br>

   <div id="quesSection">
      <div class="qForm" style="display: none;"><br><br>
         Question: <textarea name="question" class="question" cols="80" rows="2"></textarea><br>
         Choice 1: <input type="text" class="choice1" required><br>
         Choice 2: <input type="text" class="choice2" required><br>
         Choice 3: <input type="text" class="choice3" required><br>
         Choice 4: <input type="text" class="choice4" required><br>
         Answer: <input type="text" class="answer" required><br>
      </div>
   </div>

   <button type="submit" id="submit2" style="display: none;">Submit</button>
   <!-- <button type="reset" id="reset2" style="display: none;">Reset</button> -->
</body>
   <script>
      const quizNameElem = document.getElementById("quizName");
      const numOfQuesElem = document.getElementById("numOfQues");
      const timeLimitElem = document.getElementById("timeLimit");
      const submitBtn = document.getElementById("submit");
      const resetBtn = document.getElementById("reset");

      const questionElem = document.getElementsByClassName("question");
      const choice1Elem = document.getElementsByClassName("choice1");
      const choice2Elem = document.getElementsByClassName("choice2");
      const choice3Elem = document.getElementsByClassName("choice3");
      const choice4Elem = document.getElementsByClassName("choice4");
      const answerElem = document.getElementsByClassName("answer");
      const submitBtn2 = document.getElementById("submit2");
      //const resetBtn2 = document.getElementById("reset2");

      var quizId;

      resetBtn.addEventListener("click", () => {
         quizNameElem.value = "";
         numOfQuesElem.value = "";
         timeLimitElem.value = "";
      });

      submitBtn.addEventListener("click", () => {
         // send a fetch request to a php file to process the input for quiz then, display the quest forms
         const quizData = getQuizFormValues();

         if(quizData === false) {
            alert("Please fill out all the fields.")
         }
         else {
            fetch('./quiz.php', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
               },
               body: JSON.stringify(quizData)
            })
               .then((response) => response.json())
               .then((data) => {
                  quizId = data;
                  //console.log('Success:', data);
                  // here show the ques form
                  for(let i = 1; i <= quizData.ques; i++) {
                     createQuesForm();
                  }      
                  submitBtn2.style.display = "inline";
                  //resetBtn2.style.display = "inline";   
               })
               .catch((error) => {
                  console.error('Error:', error);
               });
         }   
      });

      function getQuizFormValues() {
         const quizName = quizNameElem.value;
         const numOfQues = numOfQuesElem.value;
         const timeLimit = timeLimitElem.value;

         if(quizName === "" || numOfQues === "" || timeLimit === "") {
            return false;
         }
         else {
            const quizData = {
               name: quizName,
               ques: numOfQues,
               time: timeLimit
            };
            submitBtn.style.display = "none";
            resetBtn.style.display = "none";

            return quizData;
         }       
      }

      function createQuesForm() {
         const element = document.getElementById("quesSection");
         const qForm = document.getElementsByClassName("qForm");
         const cloneForm = qForm[0].cloneNode(true);

         cloneForm.style.display = "block";
         element.appendChild(cloneForm);
      }

      submitBtn2.addEventListener("click", () => {
         // console.log(questionsData);
         const questionsData = getQuesFormValue();
         
         fetch('./question.php', {
            method: 'POST',
            headers: {
               'Content-Type': 'application/json',
            },
            body: JSON.stringify(questionsData)
         })
            .then((response) => response.json())
            .then((data) => {
               console.log('Success:', data);
               alert("Success.")
            })
            .catch((error) => {
               console.error('Error:', error);
            });
      });

      function getQuesFormValue() {
         const numOfQues = numOfQuesElem.value;
         let questionArray = [];
         let choice1Array = [];
         let choice2Array = [];
         let choice3Array = [];
         let choice4Array = [];
         let answerArray = [];

         // starts at index 1 as the "real 1st, i.e. [0]" is hidden by default.
         for (let i = 1; i <= numOfQues; i++) {
            if (i == 1) {
               questionArray += questionElem[i].value;
               choice1Array += choice1Elem[i].value;
               choice2Array += choice2Elem[i].value;
               choice3Array += choice3Elem[i].value;
               choice4Array += choice4Elem[i].value;
               answerArray += answerElem[i].value;
            }
            else {
               questionArray += ";" + questionElem[i].value;
               choice1Array += ";" + choice1Elem[i].value;
               choice2Array += ";" + choice2Elem[i].value;
               choice3Array += ";" + choice3Elem[i].value;
               choice4Array += ";" + choice4Elem[i].value;
               answerArray += ";" + answerElem[i].value;
            }
         }
         
         const questionsData = {
            questions: questionArray,
            choiceA: choice1Array,
            choiceB: choice2Array,
            choiceC: choice3Array,
            choiceD: choice4Array,
            answers: answerArray,
            quizId: quizId,
            numOfQues: numOfQues
         };
         return questionsData;
      }
   </script>
</html>